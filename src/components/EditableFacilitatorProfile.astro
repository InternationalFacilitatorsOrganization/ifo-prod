---
// filepath: /Users/finkelscott/dev/ifo-prod/src/components/EditableFacilitatorProfile.astro
import type { Facilitator } from "../lib/turso";
import ContactModal from "./ContactModal";

interface Props {
  facilitator: Facilitator;
}

const { facilitator } = Astro.props;
const name = `${facilitator.firstName} ${facilitator.lastName}`;
---

<div
  class="container lg:w-5/8 md:w-2/3 md:text-lg px-8 pt-8 md:pt-10 text-justify"
>
  <p class="solway-light text-cool-green text-xl tracking-tight" id="bio-view">
    {facilitator.bio}
  </p>
  <div id="bio-edit-container" class="hidden">
    <label class="md:text-right text-gray-500 solway-bold text-nowrap"
      >Bio:</label
    >
    <textarea
      rows={5}
      id="bio-edit"
      value={facilitator.bio || ""}
      class="w-full max-w-3xl mx-auto border border-gray-300 rounded px-3 py-2 solway focus:outline-none focus:ring-2 focus:ring-cool-green"
      data-field="bio">{facilitator.bio || ""}</textarea
    >
  </div>
</div>

<div
  class="container lg:w-2/3 md:text-lg px-8 py-4 grid grid-cols-1 md:grid-cols-[25%_1fr] md:gap-2 gap-1"
>
  <hr class="col-span-2 border-t border-t-gray-300 my-4" />

  <p
    class="md:text-right text-gray-500 solway-bold"
    id="certifications-label"
    class:list={[{ hidden: !facilitator.certifications }]}
  >
    Certifications:
  </p>
  <div
    id="certifications-view"
    class:list={[
      "pl-2 md:text-left text-cool-green pb-3 md:pb-0 solway",
      { hidden: !facilitator.certifications },
    ]}
  >
    {facilitator.certifications}
  </div>
  <input
    type="text"
    id="certifications-edit"
    value={facilitator.certifications || ""}
    class="pl-2 border border-gray-300 rounded px-3 py-1 solway focus:outline-none focus:ring-2 focus:ring-cool-green hidden"
    data-field="certifications"
  />
  <hr
    class="col-span-2 border-t border-t-gray-300 my-4"
    id="certifications-hr"
    class:list={[{ hidden: !facilitator.certifications }]}
  />

  <p
    class="md:text-right text-gray-500 solway-bold"
    id="yearsOfExperience-label"
    class:list={[{ hidden: !facilitator.yearsOfExperience }]}
  >
    Experience:
  </p>
  <div
    id="yearsOfExperience-view"
    class:list={[
      "pl-2 md:text-left text-cool-green pb-3 md:pb-0 solway",
      { hidden: !facilitator.yearsOfExperience },
    ]}
  >
    {
      facilitator.yearsOfExperience
        ? `${facilitator.yearsOfExperience} years`
        : ""
    }
  </div>
  <input
    type="text"
    id="yearsOfExperience-edit"
    value={facilitator.yearsOfExperience || ""}
    class="pl-2 border border-gray-300 rounded px-3 py-1 solway focus:outline-none focus:ring-2 focus:ring-cool-green hidden"
    data-field="yearsOfExperience"
  />
  <hr
    class="col-span-2 border-t border-t-gray-300 my-4"
    id="yearsOfExperience-hr"
    class:list={[{ hidden: !facilitator.yearsOfExperience }]}
  />

  <p
    class="md:text-right text-gray-500 solway-bold"
    id="languages-label"
    class:list={[{ hidden: !facilitator.languages }]}
  >
    Languages:
  </p>
  <div
    id="languages-view"
    class:list={[
      "pl-2 md:text-left text-cool-green solway pb-3 md:pb-0",
      { hidden: !facilitator.languages },
    ]}
  >
    {facilitator.languages}
  </div>
  <input
    type="text"
    id="languages-edit"
    value={facilitator.languages || ""}
    class="indent-6 md:indent-0 border border-gray-300 rounded px-3 py-1 solway focus:outline-none focus:ring-2 focus:ring-cool-green hidden"
    data-field="languages"
  />
  <hr
    class="col-span-2 border-t border-t-gray-300 my-4"
    id="languages-hr"
    class:list={[{ hidden: !facilitator.languages }]}
  />

  <p
    class="md:text-right text-gray-500 solway-bold"
    id="location-label"
    class:list={[{ hidden: !facilitator.location }]}
  >
    Location:
  </p>
  <div
    id="location-view"
    class:list={[
      "pl-2 md:text-left text-cool-green pb-3 md:pb-0 solway",
      { hidden: !facilitator.location },
    ]}
  >
    {facilitator.location}
  </div>
  <input
    type="text"
    id="location-edit"
    value={facilitator.location || ""}
    class="pl-2 border border-gray-300 rounded px-3 py-1 solway focus:outline-none focus:ring-2 focus:ring-cool-green hidden"
    data-field="location"
  />
  <hr
    class="col-span-2 border-t border-t-gray-300 my-4"
    id="location-hr"
    class:list={[{ hidden: !facilitator.location }]}
  />

  <p
    class="md:text-right text-gray-500 solway-bold text-nowrap"
    id="programOffered-label"
    class:list={[
      { hidden: !facilitator.programOffered && !facilitator.programsOffered },
    ]}
  >
    Program(s) Offered:
  </p>
  <div
    id="programOffered-view"
    class:list={[
      "pl-2 md:text-left text-cool-green pb-3 md:pb-0 solway",
      { hidden: !facilitator.programOffered && !facilitator.programsOffered },
    ]}
  >
    {facilitator.programOffered || facilitator.programsOffered}
  </div>
  <textarea
    id="programOffered-edit"
    rows={3}
    class="pl-2 border border-gray-300 rounded px-3 py-1 solway focus:outline-none focus:ring-2 focus:ring-cool-green hidden"
    data-field="programOffered"
    >{facilitator.programOffered || facilitator.programsOffered || ""}</textarea
  >
  <hr
    class="col-span-2 border-t border-t-gray-300 my-4"
    id="programOffered-hr"
    class:list={[
      { hidden: !facilitator.programOffered && !facilitator.programsOffered },
    ]}
  />

  <p class="md:text-right text-gray-500 solway-bold">&nbsp;</p>

  <div class="pt-8 flex flex-row gap-8" id="contact-section">
    <ContactModal
      facilitatorName={`${facilitator.firstName} ${facilitator.lastName}`}
      facilitatorEmail={facilitator.email}
      client:load
    />

    <div id="website-view">
      {
        facilitator.website && (
          <a href={facilitator.website} class="no-underline" target="_blank">
            <button class="rounded-full bg-orange-300 text-orange-800 font-bold p-1 flex-nowrap solway-bold text-sm md:text-lg px-2 md:px-3 hover:cursor-pointer hover:bg-cool-green hover:text-white focus:bg-warm-green focus:text-white text-nowrap">
              Website <i class="icon-link-ext" />
            </button>
          </a>
        )
      }
    </div>

    <a href={`../contact?book-facilitator=${name}`} class="no-underline">
      <button
        class="rounded-full bg-orange-300 text-orange-800 font-bold p-1 flex-nowrap solway-bold text-sm md:text-lg px-2 md:px-3 hover:cursor-pointer hover:bg-cool-green hover:text-white focus:bg-warm-green focus:text-white text-nowrap"
        type="button"
      >
        Request Booking
      </button>
    </a>
  </div>

  <div
    class="py-4 flex flex-row gap-2 items-center hidden"
    id="website-edit-container"
  >
    <label class="text-gray-500 solway-bold text-nowrap">Website URL:</label>
    <input
      type="text"
      id="website-edit"
      value={facilitator.website || ""}
      placeholder="https://example.com"
      class="flex-1 border border-gray-300 rounded px-3 py-1 solway focus:outline-none focus:ring-2 focus:ring-cool-green"
      data-field="website"
    />
  </div>

  <div
    id="status-view"
    class:list={[
      "pl-2 md:text-left text-white pb-3 md:pb-0 solway flex items-center",
      { hidden: !facilitator.status },
    ]}
  >
    {facilitator.status}
  </div>
  <div
    id="status-edit-container"
    class="hidden flex flex-row items-center justify-center gap-2 lg:ml-100"
  >
    <label class="text-gray-500 solway-bold text-nowrap" for="status-edit"
      >Status:</label
    >
    <select
      id="status-edit"
      class="pl-2 border border-gray-300 rounded px-3 py-1 solway focus:outline-none focus:ring-2 focus:ring-cool-green"
      data-field="status"
    >
      <option value="Active" selected={facilitator.status === "Active"}
        >Active</option
      >
      <option value="Inactive" selected={facilitator.status === "Inactive"}
        >Inactive</option
      >
    </select>
  </div>

  <div class="col-span-2 mb-4 text-center" id="edit-section">&nbsp;</div>

  <div
    class="col-span-2 mb-4 hidden justify-center gap-4 border-t border-gray-300 pt-8 my=5"
    id="action-buttons"
  >
    <button
      id="cancel-button"
      class="rounded-full px-6 py-2 solway-bold text-gray-700 hover:bg-gray-100"
    >
      Cancel
    </button>
    <button
      id="review-button"
      disabled
      class="rounded-full bg-cool-green text-white font-bold px-6 py-2 solway-bold hover:bg-warm-green disabled:bg-gray-300 disabled:cursor-not-allowed"
    >
      Review Changes
    </button>
  </div>

  <!-- Changes Summary Modal -->
  <div
    id="changes-modal"
    class="fixed inset-0 flex items-center justify-center z-50 hidden"
  >
    <div class="fixed inset-0 bg-gray-900 opacity-50" id="modal-backdrop"></div>
    <div class="bg-white rounded-lg p-6 relative z-10 max-w-lg w-full mx-4">
      <h2 class="text-2xl solway-bold text-cool-green mb-4">Review Changes</h2>
      <div class="space-y-3 mb-6" id="changes-list"></div>
      <div class="flex justify-between pt-4">
        <button
          type="button"
          id="modal-cancel"
          class="rounded-full px-6 py-2 solway-bold text-gray-700 hover:bg-gray-100"
        >
          Cancel
        </button>
        <button
          id="save-button"
          class="rounded-full bg-cool-green text-white font-bold px-6 py-2 solway-bold hover:bg-warm-green disabled:bg-gray-400"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>

  <script define:vars={{ facilitator }}>
    let isEditing = false;
    let changes = {};
    const originalData = { ...facilitator };

    const editButton = document.getElementById("edit-button");
    const cancelButton = document.getElementById("cancel-button");
    const cancelButtonHeader = document.getElementById("cancel-button-header");
    const reviewButton = document.getElementById("review-button");
    const editSection = document.getElementById("edit-section");
    const actionButtons = document.getElementById("action-buttons");
    const contactSection = document.getElementById("contact-section");
    const modal = document.getElementById("changes-modal");
    const modalBackdrop = document.getElementById("modal-backdrop");
    const modalCancel = document.getElementById("modal-cancel");
    const saveButton = document.getElementById("save-button");
    const websiteEditContainer = document.getElementById(
      "website-edit-container"
    );
    const statusEditContainer = document.getElementById(
      "status-edit-container"
    );
    const bioEditContainer = document.getElementById("bio-edit-container");

    const fields = [
      "certifications",
      "yearsOfExperience",
      "languages",
      "location",
      "programOffered",
      "bio",
      "website",
      "status",
    ];

    function toggleEdit(editing) {
      isEditing = editing;
      editButton?.classList.toggle("hidden", editing);
      cancelButtonHeader?.classList.toggle("hidden", !editing);
      actionButtons.classList.toggle("hidden", !editing);
      actionButtons.classList.toggle("flex", editing);
      contactSection.classList.toggle("hidden", editing);
      websiteEditContainer?.classList.toggle("hidden", !editing);
      statusEditContainer?.classList.toggle("hidden", !editing);
      bioEditContainer?.classList.toggle("hidden", !editing);

      // Toggle bio view separately since it's not in the grid
      const bioView = document.getElementById("bio-view");
      bioView?.classList.toggle("hidden", editing);

      fields.forEach((field) => {
        const viewEl = document.getElementById(`${field}-view`);
        const editEl = document.getElementById(`${field}-edit`);
        const labelEl = document.getElementById(`${field}-label`);
        const hrEl = document.getElementById(`${field}-hr`);

        if (editing) {
          // Show all fields when editing
          viewEl?.classList.add("hidden");
          editEl?.classList.remove("hidden");
          labelEl?.classList.remove("hidden");
          hrEl?.classList.remove("hidden");
        } else {
          // Hide empty fields when not editing
          const hasValue = originalData[field];
          viewEl?.classList.toggle("hidden", !hasValue);
          editEl?.classList.add("hidden");
          labelEl?.classList.toggle("hidden", !hasValue);
          hrEl?.classList.toggle("hidden", !hasValue);
        }
      });
    }

    function resetForm() {
      changes = {};
      fields.forEach((field) => {
        const editEl = document.getElementById(`${field}-edit`);
        if (editEl) editEl.value = originalData[field] || "";
      });
      toggleEdit(false);
    }

    editButton?.addEventListener("click", () => toggleEdit(true));
    cancelButton?.addEventListener("click", resetForm);
    cancelButtonHeader?.addEventListener("click", resetForm);

    function handleChange(field, value) {
      if (value !== originalData[field]) {
        changes[field] = value;
      } else {
        delete changes[field];
      }
      reviewButton.disabled = Object.keys(changes).length === 0;
    }

    function formatFieldName(field) {
      return field
        .replace(/([A-Z])/g, " $1")
        .replace(/^./, (str) => str.toUpperCase())
        .trim();
    }

    function showModal() {
      const changesList = document.getElementById("changes-list");
      changesList.innerHTML = "";

      Object.entries(changes).forEach(([field, newValue]) => {
        const div = document.createElement("div");
        div.className = "border-b pb-2";
        div.innerHTML = `
        <p class="text-sm text-gray-500 solway-bold">${formatFieldName(field)}</p>
        <div class="flex gap-2 items-center">
          <span class="text-gray-400 line-through text-sm">${originalData[field] || "(empty)"}</span>
          <span class="text-gray-400">â†’</span>
          <span class="text-cool-green font-semibold">${newValue || "(empty)"}</span>
        </div>
      `;
        changesList.appendChild(div);
      });

      modal.classList.remove("hidden");
    }

    async function handleSave() {
      saveButton.disabled = true;
      saveButton.textContent = "Saving...";

      try {
        const response = await fetch(`/api/facilitators/${facilitator.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(changes),
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert("Failed to save changes");
        }
      } catch (error) {
        console.error("Error saving:", error);
        alert("Error saving changes");
      } finally {
        saveButton.disabled = false;
        saveButton.textContent = "Save Changes";
      }
    }

    editButton?.addEventListener("click", () => toggleEdit(true));
    cancelButton?.addEventListener("click", () => {
      changes = {};
      fields.forEach((field) => {
        const editEl = document.getElementById(`${field}-edit`);
        if (editEl) editEl.value = originalData[field] || "";
      });
      toggleEdit(false);
    });
    reviewButton?.addEventListener("click", () => {
      if (Object.keys(changes).length > 0) showModal();
    });
    modalBackdrop?.addEventListener("click", () =>
      modal.classList.add("hidden")
    );
    modalCancel?.addEventListener("click", () => modal.classList.add("hidden"));
    saveButton?.addEventListener("click", handleSave);

    fields.forEach((field) => {
      const editEl = document.getElementById(`${field}-edit`);
      editEl?.addEventListener("input", (e) =>
        handleChange(field, e.target.value)
      );
    });
  </script>
</div>
